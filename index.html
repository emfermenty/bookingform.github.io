<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ó–∞–ø–∏—Å—å –Ω–∞ —É—Å–ª—É–≥—É</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; background: #f7f9fc; padding: 15px; }
    .card { background: #fff; border-radius: 16px; padding: 20px; max-width: 480px; margin: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.08);}
    label { display: block; margin: 15px 0 5px; }
    select, textarea { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ccc; box-sizing: border-box; }
    textarea { resize: vertical; }
    button { width: 100%; background: #4a90e2; color: #fff; border: none; padding: 14px; border-radius: 12px; margin-top: 20px; font-size: 16px; cursor: pointer;}
    button:disabled { background: #aaa; cursor: not-allowed; }
    button:hover:enabled { background: #357ab7; }
    #status { margin-top: 15px; text-align: center; font-size: 14px; color: #e74c3c;}
  </style>
</head>
<body>
  <div class="card">
    <h2>üìå –ó–∞–ø–∏—Å—å –Ω–∞ —É—Å–ª—É–≥—É</h2>

    <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—É:</label>
    <select id="service"><option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option></select>

    <label>–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è:</label>
    <select id="slot"><option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option></select>

    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–ø–∏—Å–∏ (–ø–æ –∂–µ–ª–∞–Ω–∏—é):</label>
    <textarea id="comment" rows="3" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>

    <button id="submit" disabled>–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
    <div id="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
  </div>

<script>
  // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω) ---
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
  if (tg) {
    try { tg.expand(); } catch(e){ console.warn('tg.expand error', e); }
    try { tg.ready(); } catch(e){ console.warn('tg.ready error', e); }
    console.log('Telegram WebApp detected', tg);
  } else {
    console.warn('Telegram WebApp NOT detected ‚Äî running in debug/browser mode');
  }

  const serviceSelect = document.getElementById("service");
  const slotSelect = document.getElementById("slot");
  const submitBtn = document.getElementById("submit");
  const statusDiv = document.getElementById("status");

  // –ø–∞—Ä—Å–µ—Ä query param ?test_id=...
  function getQueryParam(name) {
    try { return new URLSearchParams(window.location.search).get(name); } catch(e){ return null; }
  }
  const TEST_ID = getQueryParam('test_id'); // –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω

  // –ñ–¥—ë–º user (–Ω–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ)
  function waitForUser(timeout = 2000) {
    return new Promise(resolve => {
      if (tg && tg.initDataUnsafe?.user?.id) return resolve(tg.initDataUnsafe.user);
      let elapsed = 0;
      const iv = setInterval(() => {
        if (tg && tg.initDataUnsafe?.user?.id) {
          clearInterval(iv); return resolve(tg.initDataUnsafe.user);
        }
        elapsed += 50;
        if (elapsed >= timeout) { clearInterval(iv); resolve(null); }
      }, 50);
    });
  }

  async function loadData() {
    statusDiv.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —É—Å–ª—É–≥ –∏ —Å–ª–æ—Ç–æ–≤...';
    console.log('Loading services and slots...');
    try {
      const [servicesRes, slotsRes] = await Promise.all([
        fetch("https://antohabeuty.store/api/services"),
        fetch("https://antohabeuty.store/api/slots")
      ]);

      if (!servicesRes.ok) throw new Error('services status ' + servicesRes.status);
      if (!slotsRes.ok) throw new Error('slots status ' + slotsRes.status);

      const services = await servicesRes.json();
      const slots = await slotsRes.json();

      // –æ—á–∏—Å—Ç–∏—Ç—å
      serviceSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>';
      slotSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>';

      services.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.title || s.name || `#${s.id}`;
        serviceSelect.appendChild(opt);
      });

      slots.sort((a,b) => new Date(a.slot_datetime) - new Date(b.slot_datetime));
      slots.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = new Date(s.slot_datetime).toLocaleString('ru-RU');
        slotSelect.appendChild(opt);
      });

      statusDiv.textContent = '–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—è—é –∞–Ω–∫–µ—Ç—É...';
      console.log('services and slots loaded');
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ services/slots:', err);
      statusDiv.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + err.message;
      // –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É disabled
    }
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–Ω–∞–º–Ω–µ–∑ –ø–æ telegramId
  async function checkAnamnezForId(telegramId) {
  if (!telegramId) {
    statusDiv.textContent = '–ù–µ –Ω–∞–π–¥–µ–Ω telegramId –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–Ω–∫–µ—Ç—ã.';
    submitBtn.disabled = true;
    return false;
  }

  statusDiv.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–Ω–∫–µ—Ç—ã...';
  try {
    const res = await fetch(`https://antohabeuty.store/api/anamnez/${telegramId}`);
    if (!res.ok) throw new Error('status ' + res.status);
    const data = await res.json();
    console.log('anamnez response:', data);

    // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–Ω–æ–ø–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞
    submitBtn.disabled = true;

    if (data && data.anamnesis === true) {
      submitBtn.disabled = false;
      statusDiv.textContent = '';
      console.log('Anamnesis == true -> –∫–Ω–æ–ø–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞');
      return true;
    } else {
      // –µ—Å–ª–∏ false ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
      statusDiv.textContent = '‚ö†Ô∏è –ü–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∫–µ—Ç—É (–∞–Ω–∞–º–Ω–µ–∑).';
      console.log('Anamnesis == false -> –∫–Ω–æ–ø–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞');
      return false;
    }
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ anamnez:', err);
    submitBtn.disabled = true;
    statusDiv.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–Ω–∫–µ—Ç—ã: ' + err.message;
    return false;
  }
}


  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É ‚Äî –ø—É—Å—Ç—å –µ—Å—Ç—å –¥–∞–∂–µ –∫–æ–≥–¥–∞ –∫–Ω–æ–ø–∫–∞ disabled
  submitBtn.addEventListener('click', async (e) => {
    console.log('–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ submit; disabled=', submitBtn.disabled);
    if (submitBtn.disabled) {
      // –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
      if (tg && typeof tg.showAlert === 'function') tg.showAlert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∫–µ—Ç—É (–∞–Ω–∞–º–Ω–µ–∑).');
      else alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∫–µ—Ç—É (–∞–Ω–∞–º–Ω–µ–∑).');
      return;
    }

    // –≤–∞–ª–∏–¥–∞—Ü–∏—è selects
    if (!serviceSelect.value || !slotSelect.value) {
      if (tg && typeof tg.showAlert === 'function') tg.showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∏ —Å–ª–æ—Ç!');
      else alert('–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∏ —Å–ª–æ—Ç!');
      return;
    }

    const data = {
      action: 'book',
      service_id: parseInt(serviceSelect.value),
      slot_id: parseInt(slotSelect.value),
      comment: document.getElementById('comment').value.trim()
    };

    console.log('–ì–æ—Ç–æ–≤–∏–º –æ—Ç–ø—Ä–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç–∞:', data);

    if (tg && typeof tg.sendData === 'function') {
      try {
        tg.sendData(JSON.stringify(data));
        statusDiv.style.color = '#4caf50';
        statusDiv.textContent = '‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –±–æ—Ç–∞. –ó–∞–∫—Ä—ã—Ç–∏–µ...';
        console.log('tg.sendData called');
        setTimeout(() => { try { tg.close(); } catch(e){ console.warn('tg.close error',e); } }, 800);
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ tg.sendData:', err);
        statusDiv.textContent = '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –±–æ—Ç–∞: ' + err.message;
      }
    } else {
      // —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ ‚Äî –ø–æ–∫–∞–∂–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      console.log('tg.sendData not available ‚Äî debug mode. data:', data);
      alert('Debug: –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:\n' + JSON.stringify(data, null, 2));
    }
  });

  // –ó–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö -> –ø–æ–ª—É—á–µ–Ω–∏–µ user -> –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–Ω–∞–º–Ω–µ–∑–∞
  (async () => {
    await loadData();

    const user = await waitForUser(1500);
    let telegramId = null;

    if (user && user.id) {
      telegramId = user.id;
      console.log('User from tg.initDataUnsafe:', telegramId);
    } else if (TEST_ID) {
      telegramId = TEST_ID;
      console.log('–ò—Å–ø–æ–ª—å–∑—É—é TEST_ID –∏–∑ query:', TEST_ID);
    } else {
      // fallback –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞ ‚Äî –µ—Å–ª–∏ —Ç—ã —Ç–µ—Å—Ç–∏—Ä—É–µ—à—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ –±–µ–∑ query param
      telegramId = 6523582403;
      console.log('tg user –Ω–µ –Ω–∞–π–¥–µ–Ω –∏ TEST_ID –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é fallback id=6523582403');
      // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –≤ –ø—Ä–æ–¥–∞–∫—à–Ω–µ –ª—É—á—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–∫–æ–π fallback.
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–Ω–∞–º–Ω–µ–∑
    await checkAnamnezForId(telegramId);
  })();
</script>
</body>
</html>
